box: node
build:
  # The steps that will be executed on build
  # Steps make up the actions in your pipeline
  # Read more about steps on our dev center:
  # http://devcenter.wercker.com/docs/steps/index.html
  steps:
    - npm-install
    - script:
        name: Build
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"
          ./build
    - script:
        name: Copy output
        code: |-
          rsync -avz "$WERCKER_SOURCE_DIR/" "$WERCKER_OUTPUT_DIR"
deploy:
  steps:
    - install-packages:
        packages: openssh-client rsync
    - add-to-known_hosts:
        hostname: crypt.connectical.com
    - mktemp:
        envvar: SSH_KEY_PATH
    - create-file:
        name: write key
        filename: $SSH_KEY_PATH
        content: $SSH_KEY_PRIVATE
        overwrite: true
        hide-from-log: true
    - script:
        name: rsync upload
        code: |
          rsync -hrlxzc --safe-links \
            --rsh="ssh -i $SSH_KEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
            --exclude=.git/ \
            --exclude=build \
            --exclude=upload \
            --exclude=site.js \
            --exclude=layout/ \
            --exclude=sidebar/ \
            --exclude=site.json \
            --exclude=node_modules/ \
            . aperez@crypt.connectical.com:/srv/http/perezdecastro.org
